% ---------- helpers.tex ----------

% ---- fonts and encoding ----
% Automatically selects the best available professional font.
%
% For LuaLaTeX/XeLaTeX (modern compilers):
%   - Tries a preferred list of fonts (XCharter, Libertinus Serif, etc.).
%   - Falls back gracefully to the default if none are found.
%
% For pdfLaTeX (legacy compiler):
%   - Uses standard font packages for compatibility.
%
\ifPDFTeX
  % ---- pdfLaTeX Font Setup ----
  \usepackage[T1]{fontenc}          % font encoding
  \usepackage[utf8]{inputenc}       % input encoding
  \usepackage{XCharter}             % preferred font (or use libertine, lmodern)
\else
  % ---- LuaLaTeX/XeLaTeX Font Setup ----
  \usepackage{fontspec}             % enable font selection

  % Expl3: define variables for font selection logic
  \ExplSyntaxOn
  \seq_new:N \l__cv_font_candidates_seq
  \bool_new:N \l__cv_font_found_bool

  % \setmainfontfallback{Font 1, Font 2, ...}
  % Tries to set the main font from a comma-separated list of candidates.
  % Stops at the first font found on the system.
  \NewDocumentCommand{\setmainfontfallback}{m}{
    \seq_set_from_clist:Nn \l__cv_font_candidates_seq { #1 }
    \bool_set_false:N \l__cv_font_found_bool

    % Iterate through candidates until one is found
    \seq_map_inline:Nn \l__cv_font_candidates_seq {
      \bool_if:NF \l__cv_font_found_bool {
        \suppressfontnotfounderror=1\relax
        \IfFontExistsTF{##1}{
          \setmainfont{##1}
          \bool_set_true:N \l__cv_font_found_bool
          \typeout{Font~found:~'##1'}
        }{}
      }
    }
    % Fallback message if no fonts were found
    \bool_if:NF \l__cv_font_found_bool {
      \typeout{No~preferred~fonts~found.~Using~default.}
    }
  }
  \ExplSyntaxOff

  % Set main font from the list of preferred candidates
  \setmainfontfallback{XCharter, Libertinus Serif, Charis SIL}
\fi

%
% This file defines small, reusable helpers used by the resume commands.
% It assumes core packages are loaded by main.tex (e.g., xparse, hyperref).
%
% Best practices:
% - Uses expl3 (LaTeX3) syntax for robust string and list processing
% - Properly scoped variables with \l__cv_ prefix to avoid conflicts
% - URL handling via \tl_to_str:e to avoid manual escaping

% ---- hyperlink ----
% \link{visible text}{url}
% Creates an underlined hyperlink. Uses \detokenize via expl3 to avoid 
% having to escape underscores and other special URL characters.
\ExplSyntaxOn
\NewDocumentCommand{\link}{m m}{%
  \href{\tl_to_str:e { #2 }}{\underline{#1}}%
}
\ExplSyntaxOff

% \linkplain{visible text}{url}
% Creates a plain (non-underlined) hyperlink
\ExplSyntaxOn
\NewDocumentCommand{\linkplain}{m m}{%
  \href{\tl_to_str:e { #2 }}{#1}%
}
\ExplSyntaxOff

% ---- date formatting (YYYY/MM/DD -> Mon YYYY) ----
% Converts date strings like "2026/01/15" to "Jan 2026" format
% If input is not in YYYY/MM/DD form (e.g., "present"), prints it as-is
\ExplSyntaxOn

% Dedicated scratch vars (avoid relying on \l_tmpa_* across multiple helpers)
\seq_new:N \l__cv_date_parts_seq
\tl_new:N  \l__cv_date_month_tl
\tl_new:N  \l__cv_date_year_tl

% \dateMY{2026/01/15} -> Jan 2026
% If input is not in YYYY/MM/DD form (e.g., "present"), prints it as-is.
\NewDocumentCommand{\dateMY}{m}
  { \__cv_date_my:n { #1 } }

\cs_new_protected:Npn \__cv_date_my:n #1
  {
    \seq_set_split:Nnn \l__cv_date_parts_seq { / } { #1 }
    \int_compare:nNnTF { \seq_count:N \l__cv_date_parts_seq } = { 3 }
      {
        \tl_set:Nn \l__cv_date_year_tl  { \seq_item:Nn \l__cv_date_parts_seq { 1 } }
        \tl_set:Nn \l__cv_date_month_tl { \seq_item:Nn \l__cv_date_parts_seq { 2 } }
        % Output: Mon YYYY (day ignored)
        \__cv_month_abbrev:n { \l__cv_date_month_tl }~\l__cv_date_year_tl
      }
      {
        % Not a YYYY/MM/DD triplet -> print as-is
        #1
      }
  }

% Convert month number to 3-letter abbreviation
\cs_new:Npn \__cv_month_abbrev:n #1
  {
    \int_case:nnF { \int_eval:n {#1} }
      {
        { 1 } { Jan } { 2 } { Feb } { 3 } { Mar } { 4 } { Apr }
        { 5 } { May } { 6 } { Jun } { 7 } { Jul } { 8 } { Aug }
        { 9 } { Sep } { 10 } { Oct } { 11 } { Nov } { 12 } { Dec }
      }
      { ??? } % fallback if month is invalid
  }

\ExplSyntaxOff
